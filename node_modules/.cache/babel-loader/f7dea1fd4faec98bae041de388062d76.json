{"ast":null,"code":"// imported from ncp (this is temporary, will rewrite)\nvar fs = require('graceful-fs');\n\nvar path = require('path');\n\nvar utimes = require('../util/utimes');\n\nfunction ncp(source, dest, options, callback) {\n  if (!callback) {\n    callback = options;\n    options = {};\n  }\n\n  var basePath = process.cwd();\n  var currentPath = path.resolve(basePath, source);\n  var targetPath = path.resolve(basePath, dest);\n  var filter = options.filter;\n  var transform = options.transform;\n  var overwrite = options.overwrite; // If overwrite is undefined, use clobber, otherwise default to true:\n\n  if (overwrite === undefined) overwrite = options.clobber;\n  if (overwrite === undefined) overwrite = true;\n  var errorOnExist = options.errorOnExist;\n  var dereference = options.dereference;\n  var preserveTimestamps = options.preserveTimestamps === true;\n  var started = 0;\n  var finished = 0;\n  var running = 0;\n  var errored = false;\n  startCopy(currentPath);\n\n  function startCopy(source) {\n    started++;\n\n    if (filter) {\n      if (filter instanceof RegExp) {\n        console.warn('Warning: fs-extra: Passing a RegExp filter is deprecated, use a function');\n\n        if (!filter.test(source)) {\n          return doneOne(true);\n        }\n      } else if (typeof filter === 'function') {\n        if (!filter(source, dest)) {\n          return doneOne(true);\n        }\n      }\n    }\n\n    return getStats(source);\n  }\n\n  function getStats(source) {\n    var stat = dereference ? fs.stat : fs.lstat;\n    running++;\n    stat(source, function (err, stats) {\n      if (err) return onError(err); // We need to get the mode from the stats object and preserve it.\n\n      var item = {\n        name: source,\n        mode: stats.mode,\n        mtime: stats.mtime,\n        // modified time\n        atime: stats.atime,\n        // access time\n        stats: stats // temporary\n\n      };\n\n      if (stats.isDirectory()) {\n        return onDir(item);\n      } else if (stats.isFile() || stats.isCharacterDevice() || stats.isBlockDevice()) {\n        return onFile(item);\n      } else if (stats.isSymbolicLink()) {\n        // Symlinks don't really need to know about the mode.\n        return onLink(source);\n      }\n    });\n  }\n\n  function onFile(file) {\n    var target = file.name.replace(currentPath, targetPath.replace('$', '$$$$')); // escapes '$' with '$$'\n\n    isWritable(target, function (writable) {\n      if (writable) {\n        copyFile(file, target);\n      } else {\n        if (overwrite) {\n          rmFile(target, function () {\n            copyFile(file, target);\n          });\n        } else if (errorOnExist) {\n          onError(new Error(target + ' already exists'));\n        } else {\n          doneOne();\n        }\n      }\n    });\n  }\n\n  function copyFile(file, target) {\n    var readStream = fs.createReadStream(file.name);\n    var writeStream = fs.createWriteStream(target, {\n      mode: file.mode\n    });\n    readStream.on('error', onError);\n    writeStream.on('error', onError);\n\n    if (transform) {\n      transform(readStream, writeStream, file);\n    } else {\n      writeStream.on('open', function () {\n        readStream.pipe(writeStream);\n      });\n    }\n\n    writeStream.once('close', function () {\n      fs.chmod(target, file.mode, function (err) {\n        if (err) return onError(err);\n\n        if (preserveTimestamps) {\n          utimes.utimesMillis(target, file.atime, file.mtime, function (err) {\n            if (err) return onError(err);\n            return doneOne();\n          });\n        } else {\n          doneOne();\n        }\n      });\n    });\n  }\n\n  function rmFile(file, done) {\n    fs.unlink(file, function (err) {\n      if (err) return onError(err);\n      return done();\n    });\n  }\n\n  function onDir(dir) {\n    var target = dir.name.replace(currentPath, targetPath.replace('$', '$$$$')); // escapes '$' with '$$'\n\n    isWritable(target, function (writable) {\n      if (writable) {\n        return mkDir(dir, target);\n      }\n\n      copyDir(dir.name);\n    });\n  }\n\n  function mkDir(dir, target) {\n    fs.mkdir(target, dir.mode, function (err) {\n      if (err) return onError(err); // despite setting mode in fs.mkdir, doesn't seem to work\n      // so we set it here.\n\n      fs.chmod(target, dir.mode, function (err) {\n        if (err) return onError(err);\n        copyDir(dir.name);\n      });\n    });\n  }\n\n  function copyDir(dir) {\n    fs.readdir(dir, function (err, items) {\n      if (err) return onError(err);\n      items.forEach(function (item) {\n        startCopy(path.join(dir, item));\n      });\n      return doneOne();\n    });\n  }\n\n  function onLink(link) {\n    var target = link.replace(currentPath, targetPath);\n    fs.readlink(link, function (err, resolvedPath) {\n      if (err) return onError(err);\n      checkLink(resolvedPath, target);\n    });\n  }\n\n  function checkLink(resolvedPath, target) {\n    if (dereference) {\n      resolvedPath = path.resolve(basePath, resolvedPath);\n    }\n\n    isWritable(target, function (writable) {\n      if (writable) {\n        return makeLink(resolvedPath, target);\n      }\n\n      fs.readlink(target, function (err, targetDest) {\n        if (err) return onError(err);\n\n        if (dereference) {\n          targetDest = path.resolve(basePath, targetDest);\n        }\n\n        if (targetDest === resolvedPath) {\n          return doneOne();\n        }\n\n        return rmFile(target, function () {\n          makeLink(resolvedPath, target);\n        });\n      });\n    });\n  }\n\n  function makeLink(linkPath, target) {\n    fs.symlink(linkPath, target, function (err) {\n      if (err) return onError(err);\n      return doneOne();\n    });\n  }\n\n  function isWritable(path, done) {\n    fs.lstat(path, function (err) {\n      if (err) {\n        if (err.code === 'ENOENT') return done(true);\n        return done(false);\n      }\n\n      return done(false);\n    });\n  }\n\n  function onError(err) {\n    // ensure callback is defined & called only once:\n    if (!errored && callback !== undefined) {\n      errored = true;\n      return callback(err);\n    }\n  }\n\n  function doneOne(skipped) {\n    if (!skipped) running--;\n    finished++;\n\n    if (started === finished && running === 0) {\n      if (callback !== undefined) {\n        return callback(null);\n      }\n    }\n  }\n}\n\nmodule.exports = ncp;","map":{"version":3,"sources":["/home/agatha/open/node_modules/workbox-build/node_modules/fs-extra/lib/copy/ncp.js"],"names":["fs","require","path","utimes","ncp","source","dest","options","callback","basePath","process","cwd","currentPath","resolve","targetPath","filter","transform","overwrite","undefined","clobber","errorOnExist","dereference","preserveTimestamps","started","finished","running","errored","startCopy","RegExp","console","warn","test","doneOne","getStats","stat","lstat","err","stats","onError","item","name","mode","mtime","atime","isDirectory","onDir","isFile","isCharacterDevice","isBlockDevice","onFile","isSymbolicLink","onLink","file","target","replace","isWritable","writable","copyFile","rmFile","Error","readStream","createReadStream","writeStream","createWriteStream","on","pipe","once","chmod","utimesMillis","done","unlink","dir","mkDir","copyDir","mkdir","readdir","items","forEach","join","link","readlink","resolvedPath","checkLink","makeLink","targetDest","linkPath","symlink","code","skipped","module","exports"],"mappings":"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","sourcesContent":["// imported from ncp (this is temporary, will rewrite)\n\nvar fs = require('graceful-fs')\nvar path = require('path')\nvar utimes = require('../util/utimes')\n\nfunction ncp (source, dest, options, callback) {\n  if (!callback) {\n    callback = options\n    options = {}\n  }\n\n  var basePath = process.cwd()\n  var currentPath = path.resolve(basePath, source)\n  var targetPath = path.resolve(basePath, dest)\n\n  var filter = options.filter\n  var transform = options.transform\n  var overwrite = options.overwrite\n  // If overwrite is undefined, use clobber, otherwise default to true:\n  if (overwrite === undefined) overwrite = options.clobber\n  if (overwrite === undefined) overwrite = true\n  var errorOnExist = options.errorOnExist\n  var dereference = options.dereference\n  var preserveTimestamps = options.preserveTimestamps === true\n\n  var started = 0\n  var finished = 0\n  var running = 0\n\n  var errored = false\n\n  startCopy(currentPath)\n\n  function startCopy (source) {\n    started++\n    if (filter) {\n      if (filter instanceof RegExp) {\n        console.warn('Warning: fs-extra: Passing a RegExp filter is deprecated, use a function')\n        if (!filter.test(source)) {\n          return doneOne(true)\n        }\n      } else if (typeof filter === 'function') {\n        if (!filter(source, dest)) {\n          return doneOne(true)\n        }\n      }\n    }\n    return getStats(source)\n  }\n\n  function getStats (source) {\n    var stat = dereference ? fs.stat : fs.lstat\n    running++\n    stat(source, function (err, stats) {\n      if (err) return onError(err)\n\n      // We need to get the mode from the stats object and preserve it.\n      var item = {\n        name: source,\n        mode: stats.mode,\n        mtime: stats.mtime, // modified time\n        atime: stats.atime, // access time\n        stats: stats // temporary\n      }\n\n      if (stats.isDirectory()) {\n        return onDir(item)\n      } else if (stats.isFile() || stats.isCharacterDevice() || stats.isBlockDevice()) {\n        return onFile(item)\n      } else if (stats.isSymbolicLink()) {\n        // Symlinks don't really need to know about the mode.\n        return onLink(source)\n      }\n    })\n  }\n\n  function onFile (file) {\n    var target = file.name.replace(currentPath, targetPath.replace('$', '$$$$')) // escapes '$' with '$$'\n    isWritable(target, function (writable) {\n      if (writable) {\n        copyFile(file, target)\n      } else {\n        if (overwrite) {\n          rmFile(target, function () {\n            copyFile(file, target)\n          })\n        } else if (errorOnExist) {\n          onError(new Error(target + ' already exists'))\n        } else {\n          doneOne()\n        }\n      }\n    })\n  }\n\n  function copyFile (file, target) {\n    var readStream = fs.createReadStream(file.name)\n    var writeStream = fs.createWriteStream(target, { mode: file.mode })\n\n    readStream.on('error', onError)\n    writeStream.on('error', onError)\n\n    if (transform) {\n      transform(readStream, writeStream, file)\n    } else {\n      writeStream.on('open', function () {\n        readStream.pipe(writeStream)\n      })\n    }\n\n    writeStream.once('close', function () {\n      fs.chmod(target, file.mode, function (err) {\n        if (err) return onError(err)\n        if (preserveTimestamps) {\n          utimes.utimesMillis(target, file.atime, file.mtime, function (err) {\n            if (err) return onError(err)\n            return doneOne()\n          })\n        } else {\n          doneOne()\n        }\n      })\n    })\n  }\n\n  function rmFile (file, done) {\n    fs.unlink(file, function (err) {\n      if (err) return onError(err)\n      return done()\n    })\n  }\n\n  function onDir (dir) {\n    var target = dir.name.replace(currentPath, targetPath.replace('$', '$$$$')) // escapes '$' with '$$'\n    isWritable(target, function (writable) {\n      if (writable) {\n        return mkDir(dir, target)\n      }\n      copyDir(dir.name)\n    })\n  }\n\n  function mkDir (dir, target) {\n    fs.mkdir(target, dir.mode, function (err) {\n      if (err) return onError(err)\n      // despite setting mode in fs.mkdir, doesn't seem to work\n      // so we set it here.\n      fs.chmod(target, dir.mode, function (err) {\n        if (err) return onError(err)\n        copyDir(dir.name)\n      })\n    })\n  }\n\n  function copyDir (dir) {\n    fs.readdir(dir, function (err, items) {\n      if (err) return onError(err)\n      items.forEach(function (item) {\n        startCopy(path.join(dir, item))\n      })\n      return doneOne()\n    })\n  }\n\n  function onLink (link) {\n    var target = link.replace(currentPath, targetPath)\n    fs.readlink(link, function (err, resolvedPath) {\n      if (err) return onError(err)\n      checkLink(resolvedPath, target)\n    })\n  }\n\n  function checkLink (resolvedPath, target) {\n    if (dereference) {\n      resolvedPath = path.resolve(basePath, resolvedPath)\n    }\n    isWritable(target, function (writable) {\n      if (writable) {\n        return makeLink(resolvedPath, target)\n      }\n      fs.readlink(target, function (err, targetDest) {\n        if (err) return onError(err)\n\n        if (dereference) {\n          targetDest = path.resolve(basePath, targetDest)\n        }\n        if (targetDest === resolvedPath) {\n          return doneOne()\n        }\n        return rmFile(target, function () {\n          makeLink(resolvedPath, target)\n        })\n      })\n    })\n  }\n\n  function makeLink (linkPath, target) {\n    fs.symlink(linkPath, target, function (err) {\n      if (err) return onError(err)\n      return doneOne()\n    })\n  }\n\n  function isWritable (path, done) {\n    fs.lstat(path, function (err) {\n      if (err) {\n        if (err.code === 'ENOENT') return done(true)\n        return done(false)\n      }\n      return done(false)\n    })\n  }\n\n  function onError (err) {\n    // ensure callback is defined & called only once:\n    if (!errored && callback !== undefined) {\n      errored = true\n      return callback(err)\n    }\n  }\n\n  function doneOne (skipped) {\n    if (!skipped) running--\n    finished++\n    if ((started === finished) && (running === 0)) {\n      if (callback !== undefined) {\n        return callback(null)\n      }\n    }\n  }\n}\n\nmodule.exports = ncp\n"]},"metadata":{},"sourceType":"script"}